# Update system and install dependencies
sudo yum update -y
sudo yum install -y git python3 python3-pip python3-virtualenv jq awscli

# Clone your app
cd /opt
sudo git clone https://github.com/the-shreyashmaurya/todo-3tier-f13.git || true
cd /opt/todo-3tier-f13/backend

# Create and activate virtualenv
sudo python3 -m venv /opt/todo-venv
sudo /opt/todo-venv/bin/pip install --upgrade pip

# Install requirements
if [ -f requirements.txt ]; then
  sudo /opt/todo-venv/bin/pip install -r requirements.txt
else
  sudo /opt/todo-venv/bin/pip install flask flask_sqlalchemy flask_cors pymysql gunicorn
fi

# Create SSM refresh helper
sudo tee /usr/local/bin/refresh_db_env.sh > /dev/null <<'EOF'
#!/bin/bash
PARAM_NAME="/todo3tier/database_url"  # replace with your SSM parameter name
DEST="/etc/todo.env"
DB_URL=$(/usr/bin/aws ssm get-parameter --name "$PARAM_NAME" --with-decryption --region ap-south-1 --query "Parameter.Value" --output text 2>/dev/null || echo "")
[ -z "$DB_URL" ] && exit 0
NEW_LINE="DATABASE_URL=$DB_URL"
if [ ! -f "$DEST" ] || [ "$(cat $DEST)" != "$NEW_LINE" ]; then
  echo "$NEW_LINE" | sudo tee $DEST
  sudo chmod 640 $DEST
  sudo chown root:root $DEST
  sudo systemctl restart todo-backend || true
fi
EOF
sudo chmod +x /usr/local/bin/refresh_db_env.sh
sudo /usr/local/bin/refresh_db_env.sh || true

# Create systemd service
sudo tee /etc/systemd/system/todo-backend.service > /dev/null <<'EOF'
[Unit]
Description=Todo Backend Flask App
After=network.target

[Service]
User=root
WorkingDirectory=/opt/todo-3tier-f13/backend
EnvironmentFile=/etc/todo.env
Environment="PATH=/opt/todo-venv/bin"
ExecStart=/opt/todo-venv/bin/gunicorn --workers 3 --bind 0.0.0.0:5000 app:app
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and start service
sudo systemctl daemon-reload
sudo systemctl enable todo-backend
sudo systemctl start todo-backend

# Add cron job to refresh SSM every minute
(crontab -l 2>/dev/null; echo "* * * * * /usr/local/bin/refresh_db_env.sh >/tmp/refresh_db_env.log 2>&1") | crontab -
